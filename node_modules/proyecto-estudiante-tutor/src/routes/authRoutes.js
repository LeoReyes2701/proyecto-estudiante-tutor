const express = require('express');
const router = express.Router();
const path = require('path');
const fs = require('fs');
const bcrypt = require('bcryptjs');
const authController = require('../controllers/authControllers');
const User = require('../models/User');

router.post('/login', authController.login);

router.get('/crear-cuenta', (req, res) => {
  res.sendFile(path.resolve(__dirname, '..', '..', 'Front', 'public', 'crearCuenta.html'));
});

function generarId() {
  return Date.now().toString();
}

router.post('/registro', async (req, res) => {
  const { nombre, apellido, email, password, rol } = req.body;
  if (!nombre || !apellido || !email || !password || !rol) {
    return res.status(400).json({ error: 'Faltan campos obligatorios' });
  }
  const emailNorm = String(email).trim().toLowerCase();
  if (!emailNorm.endsWith('@est.ucab.edu.ve')) {
    return res.status(400).json({ error: 'El correo debe terminar en @est.ucab.edu.ve' });
  }

  const rutaArchivo = path.resolve(__dirname, '..', 'models', 'data', 'usuarios.json');
  let usuarios = [];
  try {
    const raw = fs.readFileSync(rutaArchivo, 'utf8');
    usuarios = JSON.parse(raw);
    if (!Array.isArray(usuarios)) usuarios = [];
  } catch (err) {
    usuarios = [];
  }

  const existe = usuarios.find(u => String(u.email).toLowerCase() === emailNorm);
  if (existe) return res.status(400).json({ error: 'El correo ya está registrado' });

  try {
    const passwordEncriptada = await bcrypt.hash(password, 10);
    const nuevoUsuario = new User(generarId(), nombre.trim(), apellido.trim(), emailNorm, passwordEncriptada, rol);
    usuarios.push(nuevoUsuario);
    fs.mkdirSync(path.dirname(rutaArchivo), { recursive: true });
    fs.writeFileSync(rutaArchivo, JSON.stringify(usuarios, null, 2), 'utf8');
    return res.status(201).json({ mensaje: 'Usuario registrado con éxito' });
  } catch (error) {
    console.error(error);
    return res.status(500).json({ error: 'Error al registrar usuario' });
  }
});

module.exports = router;


