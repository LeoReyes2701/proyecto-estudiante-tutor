const path = require('path');
const fs = require('fs');
const bcrypt = require('bcryptjs');

async function login(req, res) {
  const { email, password } = req.body;
  if (!email || !password) return res.status(400).json({ error: 'Faltan credenciales' });

  const rutaArchivo = path.resolve(__dirname, '..', 'models', 'data', 'usuarios.json');
  let usuarios = [];
  try {
    const raw = fs.readFileSync(rutaArchivo, 'utf8');
    usuarios = JSON.parse(raw);
    if (!Array.isArray(usuarios)) usuarios = [];
  } catch (err) {
    usuarios = [];
  }

  const emailNorm = String(email).trim().toLowerCase();
  const usuario = usuarios.find(u => String(u.email).toLowerCase() === emailNorm);
  if (!usuario) return res.status(401).json({ error: 'Credenciales inválidas' });

  const match = await bcrypt.compare(password, usuario.password);
  if (!match) return res.status(401).json({ error: 'Credenciales inválidas' });

  const { password: _pwd, ...usuarioSafe } = usuario;
  return res.json({ mensaje: 'Login exitoso', usuario: usuarioSafe });
}

module.exports = { login };

