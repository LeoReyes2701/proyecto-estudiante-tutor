<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear Cuenta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f8fb; }
    .card-center { max-width:720px; margin:2rem auto; }
    #messages { position: fixed; top:1rem; right:1rem; z-index:1080; width:320px; }
  </style>
</head>
<body>
  <div class="container card-center">
    <div class="card p-4 shadow-sm">
      <h3 class="mb-3">Crear Cuenta</h3>

      <form id="createAccountForm" novalidate>
        <div class="row g-2">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nombre</label>
            <input id="nombre" name="nombre" class="form-control" required />
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Apellido</label>
            <input id="apellido" name="apellido" class="form-control" required />
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Correo institucional</label>
          <input id="email" name="email" type="email" class="form-control" placeholder="usuario@est.ucab.edu.ve" required />
          <div class="form-text">El correo debe terminar en <code>@est.ucab.edu.ve</code></div>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-md-6">
            <label class="form-label">Contraseña</label>
            <input id="password" name="password" type="password" class="form-control" minlength="6" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Rol</label>
            <select id="rol" name="rol" class="form-select" required>
              <option value="">Seleccionar rol</option>
              <option value="tutor">Tutor</option>
              <option value="estudiante">Estudiante</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>

        <div id="formError" class="text-danger mb-2 d-none"></div>

        <div class="d-flex gap-2">
          <button id="submitBtn" type="submit" class="btn btn-primary">Crear cuenta</button>
          <button id="resetBtn" type="button" class="btn btn-outline-secondary">Limpiar</button>
          <div class="ms-auto align-self-center" id="statusText"></div>
        </div>
      </form>

      <hr />

      <div class="mt-2">
        <a href="/login">¿Ya tienes cuenta? Iniciar sesión</a>
      </div>
    </div>
  </div>

  <div id="messages" aria-live="polite" aria-atomic="true"></div>

  <script>
    (function () {
      const form = document.getElementById('createAccountForm');
      const nombre = document.getElementById('nombre');
      const apellido = document.getElementById('apellido');
      const email = document.getElementById('email');
      const password = document.getElementById('password');
      const rol = document.getElementById('rol');
      const submitBtn = document.getElementById('submitBtn');
      const resetBtn = document.getElementById('resetBtn');
      const formError = document.getElementById('formError');
      const statusText = document.getElementById('statusText');
      const messages = document.getElementById('messages');

      function pushToast(message, type = 'info') {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = '<div class="toast align-items-center text-bg-' + (type === 'error' ? 'danger' : (type === 'success' ? 'success' : 'info')) + ' border-0 show" role="alert" aria-live="assertive" aria-atomic="true">' +
          '<div class="d-flex"><div class="toast-body">' + message + '</div>' +
          '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>';
        messages.appendChild(wrapper);
        setTimeout(() => { try { wrapper.remove(); } catch(e){} }, 5000);
      }

      function showError(text) {
        formError.textContent = text;
        formError.classList.remove('d-none');
        pushToast(text, 'error');
        setTimeout(() => formError.classList.add('d-none'), 4000);
      }

      function setSaving(active, text = '') {
        if (active) {
          submitBtn.setAttribute('disabled', 'disabled');
          statusText.textContent = text;
        } else {
          submitBtn.removeAttribute('disabled');
          statusText.textContent = '';
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const n = nombre.value.trim();
        const a = apellido.value.trim();
        const em = email.value.trim();
        const pw = password.value;
        const r = rol.value;

        if (!n || !a || !em || !pw || !r) return showError('Todos los campos son obligatorios');
        if (!em.endsWith('@est.ucab.edu.ve')) return showError('El correo debe terminar en @est.ucab.edu.ve');
        if (pw.length < 6) return showError('La contraseña debe tener al menos 6 caracteres');

        const payload = { nombre: n, apellido: a, email: em, password: pw, rol: r };

        try {
          setSaving(true, 'Creando cuenta...');
          const res = await fetch('/auth/registro', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const json = await res.json().catch(() => null);
          setSaving(false);

          if (res.status === 201) {
            pushToast('Cuenta creada correctamente', 'success');
            form.reset();
            return;
          }

          const msg = (json && (json.error || json.mensaje)) || `Error ${res.status}`;
          showError(msg);
        } catch (err) {
          console.error('Error creando cuenta', err);
          setSaving(false);
          showError('Error de red al crear cuenta');
        }
      });

      resetBtn.addEventListener('click', () => form.reset());
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
