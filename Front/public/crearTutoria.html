<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear Tutoría — Programa Estudiante‑Tutor</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --ucab-blue:#0b3d91;
      --accent:#0b8ae6;
      --bg:#f4f7fb;
      --card:#ffffff;
      --muted:#6c757d;
    }
    html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial, sans-serif;background:linear-gradient(180deg,#eaf3ff 0%,var(--bg)100%);}
    .topbar{background:#fff;border-bottom:1px solid #eef3fb;padding:10px 20px;display:flex;align-items:center;gap:12px;box-shadow:0 4px 18px rgba(20,40,80,0.03);}
    .brand{font-weight:700;color:var(--ucab-blue);letter-spacing:0.2px}
    .nav-actions{margin-left:16px;display:flex;gap:8px;align-items:center}
    .nav-actions .btn{font-weight:600}
    .container{max-width:1100px;margin:20px auto;padding:18px}
    .card{background:var(--card);border-radius:10px;padding:20px;box-shadow:0 8px 30px rgba(11,61,145,0.04)}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
    .form-row{display:flex;gap:12px}
    label{font-weight:600}
    .muted{color:var(--muted)}
    .profile{margin-left:auto;display:flex;align-items:center;gap:10px}
    .avatar{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#0b3d91,#0b8ae6);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}.profile{display:none}}
    .btn-ghost{background:#fff;border:1px solid #e6eefb}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">UCAB — Programa Estudiante‑Tutor</div>

    <nav class="nav-actions" aria-label="Navegación principal">
      <!-- botones superiores removidos -->
    </nav>

    <div class="profile" role="region" aria-label="Perfil">
      <div class="avatar" id="avatar">PE</div>
      <div>
        <div id="perfilName" style="font-weight:700">Perfil</div>
        <div style="font-size:0.85rem;color:var(--muted)" id="perfilEmail">usuario@est.ucab.edu.ve</div>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="card grid">
      <section>
        <h3>Crear Tutoría</h3>
        <p class="muted">Crea una nueva tutoría indicando los datos básicos. Completa el formulario y pulsa "Guardar".</p>

        <form id="formCrearTutoria" class="mt-3">
          <div class="mb-3">
            <label for="titulo">Título</label>
            <input id="titulo" name="titulo" class="form-control" required />
          </div>

          <div class="mb-3">
            <label for="descripcion">Descripción</label>
            <textarea id="descripcion" name="descripcion" class="form-control" rows="4" required></textarea>
          </div>

          <div class="form-row mb-3">
            <div style="flex:1">
              <label for="fecha">Fecha</label>
              <input id="fecha" name="fecha" type="date" class="form-control" />
            </div>
            <div style="width:150px">
              <label for="hora">Hora</label>
              <input id="hora" name="hora" type="time" class="form-control" />
            </div>
          </div>

          <div class="mb-3">
            <label for="lugar">Lugar</label>
            <input id="lugar" name="lugar" class="form-control" placeholder="Aula / En línea" />
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Guardar</button>
            <button type="button" id="btnCancelar" class="btn btn-outline-secondary">Cancelar</button>
          </div>

          <div id="formMsg" class="mt-3 muted" role="status" aria-live="polite"></div>
        </form>
      </section>

      <!-- aside de Acciones rápidas eliminado según petición -->
      <aside aria-hidden="true"></aside>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    // gestión de interacciones básicas; conecta botones con las páginas/funciones existentes
    const redirect = (path) => { window.location.href = path; };

    // Acciones rápidas removidas - ya no se referencian

    // Formulario: enviar al endpoint de tutorías si existe
    const form = document.getElementById('formCrearTutoria');
    const formMsg = document.getElementById('formMsg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      formMsg.textContent = 'Guardando...';
      const payload = {
        titulo: document.getElementById('titulo').value.trim(),
        descripcion: document.getElementById('descripcion').value.trim(),
        fecha: document.getElementById('fecha').value,
        hora: document.getElementById('hora').value,
        lugar: document.getElementById('lugar').value.trim()
      };

      try {
        const token = localStorage.getItem('authToken');
        const res = await fetch('/tutorias', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
          },
          body: JSON.stringify(payload)
        });
        const json = await res.json().catch(() => ({}));
        if (res.ok) {
          formMsg.textContent = 'Tutoría creada correctamente';
          form.reset();
          const ul = document.getElementById('listaTutoriaRecientes');
          if (ul) ul.innerHTML = `<li>${payload.titulo || 'Tutoría nueva'} — ${payload.fecha || 'sin fecha'}</li>`;
          return;
        } else {
          formMsg.textContent = json && (json.error || json.message) ? (json.error || json.message) : `Error ${res.status}`;
        }
      } catch (err) {
        console.error(err);
        formMsg.textContent = 'Error de red al crear la tutoría';
      }
    });

    // Cancelar -> volver a gestion.html
    document.getElementById('btnCancelar').addEventListener('click', () => {
      redirect('/gestion.html');
    });

    // Perfil: cargar usuario local si existe
    (function initProfile() {
      const usuarioJson = localStorage.getItem('usuario');
      if (!usuarioJson) return;
      try {
        const u = JSON.parse(usuarioJson);
        document.getElementById('perfilName').textContent = u.nombre ? `${u.nombre} ${u.apellido || ''}` : 'Perfil';
        document.getElementById('perfilEmail').textContent = u.email || '';
        document.getElementById('avatar').textContent = (u.nombre ? u.nombre.charAt(0) : 'P') + (u.apellido ? u.apellido.charAt(0) : '');
      } catch (e) { /* ignore */ }
    })();
  </script>
</body>
</html>