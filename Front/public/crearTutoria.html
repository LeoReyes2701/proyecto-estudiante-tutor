<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear Tutoría — Programa Estudiante‑Tutor</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/src/styles/crearTutoria.css">
</head>
<body>

  <div class="topbar">
    <div class="brand">Programa Estudiante‑Tutor</div>
    <div class="profile">
      <div class="small muted">Tutor</div>
      <div class="avatar">MA</div>
    </div>
  </div>

  <main class="container">
    <div class="card">
      <div class="grid">
        <!-- FORMULARIO PRINCIPAL -->
        <section>
          <h3 class="mb-2">Crear Tutoría</h3>
          <p class="small muted">Define la tutoría y publícala para estudiantes.</p>

          <form id="crearTutoriaForm" class="mt-3">
            <div class="mb-3">
              <label for="titulo" class="form-label">Título</label>
              <input id="titulo" name="titulo" type="text" class="form-control" placeholder="Ej. Álgebra lineal - Repaso" required />
            </div>

            <div class="mb-3">
              <label for="descripcion" class="form-label">Descripción</label>
              <textarea id="descripcion" name="descripcion" class="form-control" rows="4" placeholder="Breve descripción de la tutoría"></textarea>
            </div>

            <div class="form-row mb-3">
              <div style="width:120px">
                <label for="cupo" class="form-label">Cupo</label>
                <input id="cupo" name="cupo" type="number" min="1" class="form-control" value="1" />
              </div>
            </div>

            <div class="form-footer">
              <a href="/gestion.html" class="btn btn-outline-secondary">Cancelar</a>
              <button type="submit" class="btn btn-primary">Publicar tutoría</button>
            </div>
          </form>
        </section>

        <!-- SIDEBAR HORARIOS (selección de horarios existentes del tutor) -->
        <aside>
          <div class="d-flex align-items-start justify-content-between mb-2">
            <div>
              <h5 class="mb-0">Horarios</h5>
              <div class="small muted">Selecciona los horarios ya creados</div>
            </div>
          </div>

          <div class="card p-2">
            <div id="horariosList" class="horarios-list">
              <div class="no-horarios">Cargando horarios...</div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button id="refreshSlots" class="btn btn-sm btn-outline-primary">Refrescar</button>
              <button id="clearSelection" class="btn btn-sm btn-outline-secondary">Borrar selección</button>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const horariosList = document.getElementById('horariosList');
      const refreshBtn = document.getElementById('refreshSlots');
      const clearBtn = document.getElementById('clearSelection');

      // Estado local: horarios disponibles y selección
      let horarios = [];
      let selectedIdx = new Set();

      // Reemplaza esta función para extraer el tutorId real (cookie, header, etc.)
      function currentTutorId() {
        // si tu app inyecta usuario via cookie 'usuario' en base64 JSON (como en app.js), leerla:
        try {
          const cookie = document.cookie.split(';').map(s=>s.trim()).find(s => s.startsWith('usuario='));
          if (cookie) {
            const val = cookie.split('=')[1];
            const user = JSON.parse(atob(val));
            return user && user.id ? String(user.id) : null;
          }
        } catch(e) {}
        // fallback: intentar cabecera simulada via global (o null)
        return null;
      }

      // render
      function renderSlots() {
        horariosList.innerHTML = '';
        if (!Array.isArray(horarios) || horarios.length === 0) {
          const n = document.createElement('div');
          n.className = 'no-horarios';
          n.textContent = 'No hay horarios creados por este tutor.';
          horariosList.appendChild(n);
          return;
        }

        horarios.forEach((s, idx) => {
          const item = document.createElement('div');
          item.className = 'horario-item';
          item.dataset.idx = idx;

          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.alignItems = 'center';
          left.innerHTML = `
            <input type="checkbox" data-idx="${idx}" ${selectedIdx.has(idx) ? 'checked' : ''} aria-label="Seleccionar horario">
            <div>
              <div class="horario-meta">${s.day || s.dia || '—'} • ${s.start || s.horaInicio || '—'} — ${s.end || s.horaFin || '—'}</div>
              <div class="small muted">${s.note || (s.description ? s.description.slice(0,60) : '')}</div>
            </div>
          `;

          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '8px';
          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'btn btn-sm btn-outline-primary';
          toggleBtn.textContent = selectedIdx.has(idx) ? 'Deseleccionar' : 'Seleccionar';
          toggleBtn.onclick = () => {
            if (selectedIdx.has(idx)) selectedIdx.delete(idx);
            else selectedIdx.add(idx);
            renderSlots();
          };

          actions.appendChild(toggleBtn);
          item.appendChild(left);
          item.appendChild(actions);
          horariosList.appendChild(item);

          // checkbox handler
          item.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
            const i = Number(e.target.dataset.idx);
            if (e.target.checked) selectedIdx.add(i);
            else selectedIdx.delete(i);
            renderSlots();
          });
        });
      }

      // fetch horarios del backend para el tutor actual
      async function loadHorarios() {
        horariosList.innerHTML = '<div class="no-horarios">Cargando horarios...</div>';
        try {
          // Si tu backend expone /horarios?tutorId=..., úsalo.
          // Intentamos deducir tutorId; si null, llamamos /horarios (filtrado en servidor)
          const tutorId = currentTutorId();
          const query = tutorId ? `?tutorId=${encodeURIComponent(tutorId)}` : '';
          const res = await fetch('/horarios' + query, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('Error al cargar horarios');
          const data = await res.json();
          // normalizar array de slots: cada elemento puede tener campos distintos según tu modelo
          horarios = Array.isArray(data) ? data.map(h => ({
            id: h.id || h._id || null,
            day: h.day || h.dia || (h.slots && h.slots[0] && h.slots[0].day) || '',
            start: h.start || h.horaInicio || (h.slots && h.slots[0] && h.slots[0].horaInicio) || '',
            end: h.end || h.horaFin || (h.slots && h.slots[0] && h.slots[0].horaFin) || '',
            note: h.note || h.descripcion || ''
          })) : [];
          selectedIdx = new Set();
          renderSlots();
        } catch (err) {
          console.error(err);
          horariosList.innerHTML = '<div class="no-horarios">No se pudieron cargar los horarios.</div>';
        }
      }

      refreshBtn.addEventListener('click', loadHorarios);
      clearBtn.addEventListener('click', () => {
        selectedIdx.clear();
        renderSlots();
      });

      // Al enviar el formulario, adjuntar la selección de horarios (ids) al payload
      document.getElementById('crearTutoriaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const titulo = document.getElementById('titulo').value.trim();
        if (!titulo) { alert('El título es requerido'); return; }
        const selected = Array.from(selectedIdx).map(i => horarios[i]).filter(Boolean).map(s => ({ id: s.id, day: s.day, start: s.start, end: s.end }));

        const payload = {
          titulo,
          descripcion: document.getElementById('descripcion').value.trim(),
          cupo: Number(document.getElementById('cupo').value) || 1,
          // adjuntamos slots seleccionados (backend deberá interpretar)
          slots: selected
        };

        try {
          const res = await fetch('/tutorias', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const err = await res.json().catch(()=>({ error: 'Error' }));
            alert('No se pudo crear la tutoría: ' + (err.error || err.message || res.status));
            return;
          }
          alert('Tutoría publicada correctamente');
          window.location.href = '/gestion.html';
        } catch (err) {
          console.error(err);
          alert('Error de red al crear la tutoría');
        }
      });

      // cargar initial
      loadHorarios();
    })();
  </script>
</body>
</html>